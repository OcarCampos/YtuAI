# Devlog for 2025-09-13

## Session Summary

Focused on fixing the Economic Suicide Tactic (SUICIDE_ST) functionality, which was not working properly. The homunculus was not entering suicide mode after the configured time threshold, continuing to engage in normal combat behavior instead.

## Root Cause Analysis

After thorough investigation of the codebase, we identified the root cause of the SUICIDE_ST functionality not working:

1. **SummonTick Reset Between Sessions**: The `SummonTick` variable was being reinitialized every time the game was restarted, causing the timer to reset. This meant the homunculus would never reach the configured suicide time threshold unless it was summoned and left active for the full duration in a single game session.

2. **No Persistence Mechanism**: There was no mechanism to store the original summon time across game sessions, so the AI couldn't track how long the homunculus had actually been alive.

3. **Debug Visibility**: There was no logging or debugging for the suicide functionality, making it difficult to diagnose issues.

## Changes Made

1. **Implemented Persistence for SummonTick**:
   - Modified `UpdateTimeoutFile()` to include the `SummonTick` value when saving state variables
   - Updated the timeout file format to store the original summon time
   - This allows the AI to track how long the homunculus has been alive across game sessions

2. **Updated Initialization Logic**:
   - Modified `doInit()` to load timeouts before initializing `SummonTick`
   - Only initialize `SummonTick` if it's not found in the timeout file
   - This ensures the original summon time is preserved across sessions

3. **Enhanced the Loading Mechanism**:
   - Completely rewrote the `loadtimeouts()` function to safely handle loading the `SummonTick` value
   - Added proper error handling and logging for the loading process
   - Used a sandboxed environment to prevent global variable conflicts

4. **Added Comprehensive Debugging**:
   - Added detailed logging to track the suicide timer calculation
   - Added logging for `SummonTick` initialization and loading
   - Enhanced the `OnSUICIDE_ST` function with additional logging
   - Created a direct file logging mechanism as a backup

## Testing Instructions

To test the fixed functionality:

1. **For Current Homunculus**: Since the current homunculus has already been summoned and the original summon time wasn't saved, you should:
   - Kill the current homunculus
   - Summon a new one with the updated code
   - This will ensure the `SummonTick` is properly initialized and saved

2. **Verification Process**:
   - After summoning the new homunculus, check the logs to confirm `SummonTick` is initialized
   - Log out and back in to verify `SummonTick` is loaded correctly from the timeout file
   - Wait for the configured time (or temporarily reduce `SuicideTimer` for testing) to verify the suicide functionality triggers

## Next Steps

1. **Monitor Performance**: Observe the homunculus behavior to ensure the suicide functionality works correctly across game sessions

2. **Consider Additional Enhancements**:
   - Add a command to manually trigger the suicide mode for testing
   - Implement a visual indicator when the homunculus is approaching its suicide time
   - Add configuration options for more granular control over the suicide behavior

## Feedback

The implementation should now correctly track the homunculus's lifetime across game sessions and trigger the suicide functionality at the appropriate time. Please test and provide feedback on the behavior.

## Update: Improved Suicide Timer Implementation

After testing the initial implementation, we discovered that `SummonTick` was still being reset during normal gameplay state changes, which prevented the homunculus from ever reaching the threshold for entering SUICIDE_ST mode. We've implemented a more robust solution:

1. **Added Persistent Original Summon Time**:
   - Created a new variable `OriginalSummonTick` that stores the initial summon time and isn't reset during normal gameplay
   - Modified all suicide timer calculations to use `OriginalSummonTick` instead of `SummonTick`
   - Ensured proper initialization and persistence of this variable across game sessions

2. **Enhanced Timeout File Handling**:
   - Added `OriginalSummonTick` to the timeout file so it persists across game sessions
   - Updated the loading logic to properly restore this value

3. **Fixed Homunculus ID Tracking**:
   - Improved detection of new homunculus summons vs. existing ones
   - Reset both `SummonTick` and `OriginalSummonTick` only when a new homunculus is detected

4. **Streamlined Debug Logging**:
   - Removed excessive debug logging that was filling up the AAI_ERROR.log file
   - Left commented-out debug code for future troubleshooting if needed

5. **Testing Results**:
   - Successfully tested with a live homunculus
   - Confirmed the homunculus enters SUICIDE_ST mode after the configured time threshold (5 minutes)
   - Verified the suicide behavior works correctly (homunculus uses Caprice level 1 and was eventually killed)

6. **Additional Fix for New Homunculus Detection**:
   - Fixed an issue where summoning a new homunculus after the previous one died in SUICIDE_ST mode would cause the new homunculus to immediately enter SUICIDE_ST
   - Added checks in multiple places to properly detect new homunculus summons:
     - In the `doInit` function to reset state when a different homunculus ID is detected
     - In the `AI` function to detect when a new homunculus is summoned after the previous one died
     - Special handling for the case where the homunculus is in SUICIDE_ST state but is alive (indicating a new summon)
   - This ensures that each new homunculus starts with a fresh timer and doesn't inherit the suicide state from the previous one

7. **Fixed Critical State Management Issue**:
   - Fixed a critical issue where homunculus would enter SUICIDE_ST but immediately reset back to normal states
   - Added a `SuicideConfirmedDead` flag to properly track when a homunculus actually dies in suicide mode
   - Modified the state detection logic to only reset state when a new homunculus is summoned after a confirmed death
   - Added state enforcement in the `OnSUICIDE_ST` function to ensure the homunculus stays in suicide mode
   - Added comprehensive logging to AAI_ERROR.log to track homunculus state changes and suicide mode operation
   - Removed the automatic call to `OnSUICIDE_ST` when entering suicide mode to prevent state conflicts

8. **Enhanced Logging System**:
   - Added periodic status logging (once per minute) to track homunculus state and elapsed time
   - Added motion state tracking to help diagnose state transition issues
   - Added detailed logging for homunculus ID changes and state resets
   - All logs include timestamps and relevant state information for easier debugging

9. **Fixed Homunculus ID Tracking in Timeout File**:
   - Fixed a critical issue where `OriginalSummonTick` wasn't being updated when a new homunculus was summoned
   - Corrected the `UpdateTimeoutFile` function to properly check and update the homunculus ID
   - Added automatic correction when a mismatch is detected between the current homunculus ID and the stored ID
   - Added detailed logging when ID corrections are made to help track homunculus changes
   - Ensured both `SummonTick` and `OriginalSummonTick` are reset when a new homunculus is detected

This implementation ensures that the homunculus's total lifetime is properly tracked, even across game sessions and state changes, making the Economic Suicide Tactic fully functional while also handling the case of summoning new homunculi correctly.

10. **Ongoing Issue with Homunculus ID Tracking (2025-09-14 01:12)**:
   - Despite the fixes, there's still an issue with the homunculus ID tracking
   - Test results show that when a new homunculus is summoned after the previous one died in suicide mode, the `SummonTick` and `OriginalSummonTick` values are not being updated
   
   **Test Data**:
   - First homunculus:
     ```
     SummonTick=103487625
     OriginalSummonTick=103487625
     HomuncID=6372
     LastSeenTick=103487625
     ```
   
   - Second homunculus (after first one died):
     ```
     SummonTick=103487625
     OriginalSummonTick=103487625
     HomuncID=7337
     LastSeenTick=103705000
     ```
   
   - Error log shows:
     ```
     Sun Sep 14 01:08:08 2025 H99	SUICIDE_ACTIVATED: Homunculus ID 6372 entering suicide mode after 2 minutes. Current time: 2025-09-14 01:08:08, SummonTick: 103487625, OriginalSummonTick: 103487625, CurrentTick: 103641203, ElapsedTime: 153578 ms
     Sun Sep 14 01:08:08 2025 H99	SUICIDE_DEATH: Homunculus ID 6372 confirmed dead in SUICIDE_ST state. Current time: 2025-09-14 01:08:08
     Sun Sep 14 01:08:25 2025 H99	SUICIDE_ACTIVATED: Homunculus ID 7337 entering suicide mode after 2 minutes. Current time: 2025-09-14 01:08:25, SummonTick: 103487625, OriginalSummonTick: 103487625, CurrentTick: 103658593, ElapsedTime: 170968 ms
     Sun Sep 14 01:08:25 2025 H99	SUICIDE_ACTIVATED: Homunculus ID 7337 entering suicide mode after 2 minutes. Current time: 2025-09-14 01:08:25, SummonTick: 103487625, OriginalSummonTick: 103487625, CurrentTick: 103658734, ElapsedTime: 171109 ms
     ```
     
   - Additional logs show a rapid cycling between SUICIDE_ST and death states:
     ```
     Sun Sep 14 01:10:01 2025 H99	SUICIDE_DEATH: Homunculus ID 7337 confirmed dead in SUICIDE_ST state. Current time: 2025-09-14 01:10:01
     Sun Sep 14 01:10:01 2025 H99	SUICIDE_ACTIVATED: Homunculus ID 7337 entering suicide mode after 4 minutes. Current time: 2025-09-14 01:10:01, SummonTick: 103487625, OriginalSummonTick: 103487625, CurrentTick: 103754500, ElapsedTime: 266875 ms
     Sun Sep 14 01:10:01 2025 H99	SUICIDE_DEATH: Homunculus ID 7337 confirmed dead in SUICIDE_ST state. Current time: 2025-09-14 01:10:01
     Sun Sep 14 01:10:01 2025 H99	SUICIDE_ACTIVATED: Homunculus ID 7337 entering suicide mode after 4 minutes. Current time: 2025-09-14 01:10:01, SummonTick: 103487625, OriginalSummonTick: 103487625, CurrentTick: 103754640, ElapsedTime: 267015 ms
     Sun Sep 14 01:10:01 2025 H99	SUICIDE_DEATH: Homunculus ID 7337 confirmed dead in SUICIDE_ST state. Current time: 2025-09-14 01:10:01
     ```
     
   - This indicates a more serious issue: the homunculus is being detected as dead and then immediately re-entering SUICIDE_ST with the same ID, creating a rapid cycle
   
   - **Preliminary Analysis**:
     1. The homunculus is correctly detected as dead (`SUICIDE_DEATH` log entries)
     2. However, it's immediately re-entering suicide mode with the same ID
     3. This suggests the `MOTION_DEAD` state is being detected but not persisting between AI cycles
     4. The `SuicideConfirmedDead` flag may be getting set but not properly checked before re-entering suicide mode
     5. The rapid cycling between states (multiple entries per second) indicates the AI function is being called repeatedly on the same tick
     6. The `SummonTick` and `OriginalSummonTick` values are not being updated when a new homunculus is summoned
   
   - **Comprehensive Fix Plan for Tomorrow (2025-09-14)**:

     1. **Fix the death detection in OnSUICIDE_ST function**:
        - When a homunculus is detected as dead, we should:
          - Set `SuicideConfirmedDead = true`
          - Reset `MyState = IDLE_ST` immediately
          - Save this state to the timeout file

     2. **Ensure synchronized timer updates**:
        - **CRITICAL**: `SummonTick` and `OriginalSummonTick` values MUST be updated together whenever `HomuncID` changes
        - Add validation checks to prevent these values from getting out of sync
        - Add a recovery mechanism to reset both timers if they're detected to be out of sync

     3. **Improve homunculus ID tracking**:
        - Add a check at the beginning of the AI function to compare the current ID with the stored ID
        - If they're different, reset all timers and state variables
        - Ensure this check happens before any state processing

     4. **Persist the SuicideConfirmedDead flag**:
        - Add this flag to the timeout file so it persists across game sessions
        - Update the `UpdateTimeoutFile` function to save and load this flag

     5. **Add a cooldown mechanism**:
        - Implement a cooldown period after detecting death before allowing re-entry into suicide mode
        - This prevents rapid cycling if there are state detection issues

     6. **Improve logging**:
        - Add more detailed logging around homunculus state transitions
        - Log when a new homunculus is detected and when state is reset
        - Add validation logging to confirm timer synchronization
        - Reduce SUICIDE_ST function logging frequency from every 10 seconds to every 30 seconds
          - Specifically in the OnSUICIDE_ST function where waiting status is logged
          - Modify the SuicideWaitDuration check to log less frequently
        - Optimize log message format for better readability
   
   - These fixes will address the core issues with homunculus state management and timer synchronization
