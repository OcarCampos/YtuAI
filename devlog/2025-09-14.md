# Devlog for 2025-09-14

## Session Goals

1. Fix the issues with `SummonTick` and `OriginalSummonTick` variables to properly track homunculus lifetime
2. Address the rapid cycling between SUICIDE_ST and death states
3. Ensure proper homunculus ID tracking when a new homunculus is summoned

## Current Issues

Based on the previous devlog (2025-09-13), we've identified several critical issues:

1. **Timer Synchronization**: `SummonTick` and `OriginalSummonTick` values are not being updated when a new homunculus is summoned
2. **State Management**: The homunculus is rapidly cycling between SUICIDE_ST and death states
3. **ID Tracking**: New homunculus IDs are detected but not properly triggering timer resets

## Key Findings

After extensive testing, we've identified the core problem:

**The `OriginalSummonTick` variable should update every time we invoke the homunculus, but it doesn't.**

Our problem lies in our inability to properly detect homunculus invocation events. The variable must update every time we use the skill to invoke the homunculus, regardless of whether it died because:

1. It was in SUICIDE_ST state
2. It was killed during normal combat
3. It was killed and immediately reinvoked
4. We logged out and logged back in with a new summon

## Planned Fixes

1. **Implement robust homunculus invocation detection**
   - Create a detection mechanism that works for all invocation scenarios
   - Don't rely solely on `SuicideConfirmedDead` flag or motion states
   - Focus on detecting new homunculus IDs as the primary indicator

2. **Fix death detection in OnSUICIDE_ST function**
   - Ensure proper state transition when a homunculus is detected as dead
   - Persist the death state to prevent re-entering suicide mode

3. **Synchronize timer updates**
   - Ensure `SummonTick` and `OriginalSummonTick` are always updated together
   - Add validation to prevent these values from getting out of sync

4. **Improve homunculus ID tracking**
   - Add robust checks to detect new homunculus summons
   - Reset all timers and state variables when a new homunculus ID is detected

5. **Implement persistence for critical state flags**
   - Add `SuicideConfirmedDead` flag to the timeout file
   - Ensure state persistence across game sessions

6. **Optimize logging**
   - Reduce logging frequency in the OnSUICIDE_ST function
   - Improve log message format for better readability

## Progress

The issue with `OriginalSummonTick` has been resolved after several iterations.

### Summary of Changes

1.  **Implemented Robust Invocation Detection**: A new system was added to `AI_main.lua` to reliably detect when a new homunculus is summoned. This logic now correctly differentiates between a true re-summon and a temporary disappearance caused by teleporting.
    -   The AI now tracks the homunculus's alive status across game ticks using `homunculusPreviouslyAlive`.
    -   A new flag, `homunculusConfirmedGone`, is set to `true` only when the homunculus's disappearance is confirmed by a `MOTION_DEAD` state.

2.  **Conditional Timer Reset**: The logic to reset `OriginalSummonTick` was updated to handle all scenarios correctly:
    -   **First Summon**: The timer is initialized on the first summon of a new game session.
    -   **Re-Summon After Death**: The timer is reset only if the previous homunculus was confirmed to be gone via the `MOTION_DEAD` state.
    -   **Teleporting**: The timer is *not* reset, as the absence is not confirmed by a death state.

3.  **Fixed Data Persistence**: The root cause of the stale timer data was addressed.
    -   The `loadtimeouts()` function, which was loading old data from the timeout file, has been completely removed.
    -   A new function, `UpdateTimeoutFile()`, was created to immediately save the new `OriginalSummonTick` to the timeout file the moment it is reset.

This ensures the suicide timer is always accurate for the current homunculus, resolving the premature `SUICIDE_ST` bug.
