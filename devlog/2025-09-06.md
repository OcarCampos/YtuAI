# Devlog - 2025-09-06

## Project Initialization

-   Initialized a new git repository in the project folder.
-   Defined the initial project goals:
    -   Understand and improve the `AI-dieter` custom homunculus AI.
    -   Use `AI-original` as a reference.
    -   Focus on the Vanilmirth and Dieter homunculi.
    -   Translate Korean documentation and create new English documentation.
-   Set up the project structure with a `README.md` and a `devlog` directory.

## Next Steps

-   Explore the file structure of the `AI-original` and `AI-dieter` directories to understand their contents.

## Documentation and Translation

-   Translated the Korean user manual from `AI-original` to understand its core concepts.
-   Created comprehensive English documentation for `AI-dieter`'s configuration (`H_Config.lua`) and tactics (`H_Tactics.lua`), located in the `documentation/` directory.
-   Completed the translation of all Korean comments in the `AI-original` core scripts (`AI.lua`, `AI_M.lua`, `Const.lua`) to English.

## Refactoring

-   Performed an initial refactoring pass on `AI-dieter/USER_AI/AI_main.lua`.
-   Added structured headers and comments to the initialization, command processing, and state processing functions to improve code readability and maintainability.

## Next Steps

-   Discuss and plan the implementation of AI improvements.

## AI Enhancements (Iteration 1)

### 1. Smart-Casting System
-   **Goal**: Improve leveling efficiency for the Vanilmirth.
-   **Features**:
    -   **SP Management**: The AI now conserves SP by switching to basic attacks when below a configurable threshold (`V_SkillSPMin`).
    -   **Mob-Density Casting**: `Caprice` is now only used when a minimum number of monsters are grouped together (`V_CapriceMobMin`), preventing wasted SP.
    -   **Low HP Flee**: The homunculus will now automatically flee to the owner if its HP drops below a set threshold (`FleeHP`).

### 2. Dynamic Kiting System
-   **Goal**: Enhance homunculus survivability.
-   **Features**:
    -   **Reactive Kiting**: The AI will automatically begin kiting enemies if its HP drops below a configurable threshold (`K_ReactiveKiteHP`).
    -   **Stuck Detection**: The kiting logic can now detect if the homunculus is stuck and will attempt to move to an alternative position to break free (`K_StuckDetection`).

### 3. Priority-Based Skill Engine
-   **Goal**: Create a flexible and extensible skill system for future development.
-   **Features**:
    -   Created a new `H_Skills.lua` file to act as a skill database.
    -   Developed a new `ChooseSkill()` function in `AzzyUtil.lua` to act as the core skill engine, selecting the best skill based on priority and conditions.
    -   Refactored `AI_main.lua` to replace the old, complex skill logic with a simple call to the new engine.

### 4. Economic Suicide Tactic
-   **Goal**: Save zeny by avoiding the use of "Seed of Life".
-   **Features**:
    -   **Automated Timer**: The AI now tracks the homunculus's uptime since it was summoned.
    -   **Configurable Behavior**: You can enable or disable this tactic and set the timer (in minutes) in `H_Config.lua`.
    -   **Suicide State**: Once the timer expires, the AI enters a new state, disables all defensive behaviors, and actively seeks out the nearest monster to be defeated.

## Modified Files Summary (`AI-dieter`)

-   `AI-dieter/USER_AI/AI_main.lua`: 
    -   Refactored and commented the main AI logic.
    -   Added flee and reactive kiting logic.
    -   Replaced the old skill selection system with the new priority-based engine.
    -   Implemented the core logic for the Economic Suicide Tactic, including a new `SUICIDE_ST` state.

-   `AI-dieter/USER_AI/H_Config.lua`:
    -   Added new configuration options for the Smart-Casting (`V_CapriceMobMin`, `V_SkillSPMin`) and Dynamic Kiting (`K_ReactiveKiteHP`, `K_StuckDetection`) systems.
    -   Added new configuration options for the Economic Suicide Tactic (`EnableSuicideTactic`, `SuicideTimer`).

-   `AI-dieter/USER_AI/AzzyUtil.lua`:
    -   Modified `GetDanceCell` to support the new stuck detection logic.
    -   Added the new `ChooseSkill()` function and its helper, `GetSkillLevel()`, to power the priority-based skill engine.

-   `AI-dieter/USER_AI/H_Skills.lua`:
    -   Created this new file to serve as the database for the priority-based skill engine. Initially populated with `Caprice`.

-   `AI-dieter/USER_AI/README.md`:
    -   This file was removed, and its contents were merged into the root `README.md` to create a single, comprehensive source of project information.

## Next Steps

-   Await feedback from testing the first iteration of the improved AI.

## Bug Fixes (Iteration 1)

-   **Resolved AI Initialization Crash**:
    -   **Issue**: The AI was crashing on startup with a `ConfigPath' (a nil value)` error.
    -   **Cause**: The main `AI.lua` loader was not being copied to the game's `AI` directory, so the custom AI was never properly initialized.
    -   **Fix**: Created a new loader file (`AI-dieter/AI.lua`) and updated the `README.md` with the correct installation instructions.

-   **Fixed Skill Engine Crash**:
    -   **Issue**: The AI crashed with an `attempt to index field '?' (a nil value)` error when trying to use `Caprice`.
    -   **Cause**: The `SkillAOEInfo` table in `H_SkillList.lua` was missing an entry for `HVAN_CAPRICE`, which is required by the `GetMobCount` function.
    -   **Fix**: Added the necessary AoE data for `Caprice` to the `SkillAOEInfo` table.

## Feedback from testing

### AI-dieter directory files.

-   After testing our configuration, the working files from the Ragnarok client were copied back to the AI-dieter directory. The current state of the files reflect the custom AI we are working on. This was already installed over the azzy ai files. I suspect we no longer need to download the original azzy AI files as part of our install process and we can use the whole AI-dieter directory as our custom AI. We should review and update the README file to reflect this. We should cite the original Azzy AI in the readme as that is the basis for our custom AI.
-   We should rename the AI-dieter directoy to something else as this is now our custom AI folder. VanilAI is fine as Vanilmirth is the homunculus we are testing this AI for.
-   Upon reviewing AI file H_config.lua I could notice that EnableSuicideTactic was set to 0, we need to set it to 1 to enable the suicide tactic and test it as I couldn't test in this run.
-   Upong reviewing the rest of the files in the AI-dieter directory I could notice that there are many files that maybe are not being used or were intended for some use but are note currently being used. We need to review every file and update the header to reflect the current state of the file. We should make a list of the files that are not being used to asses why they were created and if they serve any purpose. There may be potential optimizations that we can do to the code to make it more efficient.
-   Despite we created documentation for configurations and tactics, documentation is not complete either. We should create a document that explains what every file is for and what it does. We should also create a document that explains the logic of the AI and how it works. We should also create a document that explains the configuration options and how to use them. This based on the review we do of what files are being used which no together with their header information and our own analysis of the file contents. I added the file Documentation.md to the AI-dieter directory so we can use that as reference as it is the md version converted from the original Documentation.pdf. This file can serve as reference for generating our own improved version of the document.
-   At our main readme we should be explicit about the language the AI is written in so any new developer can know what to expect when browsing the files.
-   We should edit file windsurfrules to reflect the document base we are working with so it can serve as a rule set for the AI agent we are using to cooperate with this project. The current windsurfrules file is meant for a web development project, it needs to be configured for this type of project.

### Homunculus behavior.

-   I started playing with the homunculus at level 12. Currently the homunculus is level 28.
-   The stats for the homunculus are the following:
    -   Level: 28
    -   HP: 4967
    -   SP: 660
    -   Atk: 71
    -   Matk: 291
    -   Hit: 223
    -   Critical: 15
    -   Def: 126
    -   Mdef: 87
    -   Flee: 68
    -   Aspd: 144 
-   Overall the homunculus moves fluidly and his behavior is consistent. There are minor things to tweak.
-   Caprice is not being used efficiently, it should be limited based on SP availability only and not on monster density. If SP is below a certain threshold, the homunculus should not cast caprice until is has recovered enough SP to cast again for a while. As you notice from the current homunculus stats, Matk is quite high and it can be used to deal a more damage than physicals attacks. Therefore at this stage is a good idea to be more aggresive with caprice. If we see a monster, drop the caprice on it if we have enough SP to cast it.
-   As for tactics, I think we should improve the behavior in base of the HP. If the homunculus has lower than certain % of HP it should flee if attacking a monster. If moving around it should change to passive mode until it recovers. Both behaviors until it recovers at least 30% of HP. When suicide tactic is on, the homunculus should respect the suicide rules when the timing requires it. This is, during the first 20 minutes of existence it should follow the improved behavior we are suggesting, when the 20 minutes mark is reached, it should follow the suicide tactic rules to allow the homunculus to die and save zeny.
-   As for the suicide tactic, I couldn't verify it yet. I tried to witness the behavior but usually we were overswarmed and the homunculus was killed before I could check his behavior. Nonetheless, we must make sure is fully implemented at the code as I will notice it at some point when our homunculus is strong enough to not be killed if he doesn't provoke monsters to kill him.




