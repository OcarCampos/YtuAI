# Devlog for 2025-09-09

## Session Summary

This session focuses on addressing the feedback from the previous testing phase. Key objectives include renaming the project to YtuAI, cleaning up the codebase by removing unnecessary files, and implementing significant improvements to the Homunculus's combat behavior, particularly concerning SP management and skill casting efficiency.

## Changes Made

- **Project Renamed**: The project has been renamed from `VanilAI` to `YtuAI`. All relevant files, including the `README.md` and documentation, have been updated to reflect the new name. Please remember to manually rename the `YtuAI` folder and the documentation file.
- **Codebase Cleanup**: Obsolete files and documentation have been identified for removal from the `USER_AI` directory. The `data` directory has also been analyzed, and unnecessary files have been marked for manual deletion to streamline the project.
- **Optimized Skill Cooldowns**: Implemented a cooldown system in `AI_main.lua` to prevent the AI from spamming skills. This was based on the skill's known formula: `Cooldown = 2 + (Skill Level * 0.2) seconds`. The AI now respects the `Caprice` skill's cooldown, ensuring more efficient and resource-friendly casting.
- **Implemented Smart SP Management**: Replaced the static skill priority system with a dynamic, function-based approach in `H_Skills.lua`. The AI now adjusts its skill usage based on a tiered logic:
    - **Aggressive (SP > 70%)**: High priority for `Caprice`.
    - **Balanced (30% < SP <= 70%)**: Medium priority, balancing skill use and conservation.
    - **Conservative (SP <= 30%)**: Low priority, using the skill only when necessary.
    - **Emergency Override**: High priority if mobbed by three or more enemies, regardless of SP.
- **Documentation Overhaul**: Revised `README.md`, `documentation/YtuAI_Documentation.md`, and the project's rules to reflect the new focus, features, and development workflow.
- **Cleaned Friend List**: Removed the inherited, pre-populated friend list from `A_Friends.lua` to provide a clean, default file for new users.
- **Project-Wide Renaming**: Updated the project name from `VanilAI` to `YtuAI` in all file headers within the `YtuAI/USER_AI` directory for consistency.

## Bug Fixes & Testing (Afternoon Session)

Following the morning's refactor, a testing session revealed a persistent and critical bug that caused the game client to crash. After several attempts to fix symptoms of the issue, the root cause was identified and resolved:

- **Restored Missing `V_SKILLLEVEL` Constant**: The primary cause of the recurring `bad argument #1 to 'GetV'` error was a missing game constant. The `V_SKILLLEVEL` constant was not defined in `Const_.lua`, causing any function that tried to check a skill's level to fail. The constant has been restored, resolving the core issue.

## Adjustments & Tuning

After the bug was fixed, further testing revealed that some features were not behaving as expected:

- **HP-Based Recovery Tuning**: The default `FleeHP` and `RecoverHP` values in `H_Config.lua` were too low to be easily observable. These have been adjusted to 30 and 50 respectively.
- **Smart SP Management Conflict Resolution**: A conflict between `V_SkillSPMin` in `H_Config.lua` and `min_sp_pct` in `H_Skills.lua` was resolved by aligning the values.

## New Feature: SP Recovery Mode

To prevent the AI from constantly toggling between skills and melee attacks when SP is low, we've implemented an SP recovery mode:

- **V_SkillSPRecover Configuration**: Added a new `V_SkillSPRecover` option in `H_Config.lua` that defines the SP percentage the homunculus must recover to before using skills again after falling below `V_SkillSPMin`.
- **SP Recovery Logic**: Implemented logic in `AI_main.lua` to set and reset an `IsSPRecovering` flag based on SP levels. When SP drops below `V_SkillSPMin`, the AI enters recovery mode and will only use basic attacks until SP recovers to `V_SkillSPRecover`.

## Enhancement to SP Recovery Logic

- **Target Searching During SP Recovery**: Modified the SP recovery logic in `AI_main.lua` to allow the homunculus to continue looking for targets while in SP recovery mode, but without using skills. This makes the homunculus more aggressive while still conserving SP.
- **HP Recovery Logic Unchanged**: The HP recovery logic remains unchanged, keeping the homunculus passive during HP recovery to ensure survival.

## Player Command Override Feature

- **Override HP Recovery Mode**: Implemented a `PlayerCommandOverride` flag to ensure that direct player attack commands are always obeyed, even when the homunculus is in a low-HP recovery state. This prevents the AI's self-preservation logic from incorrectly canceling a player-issued command.

## Next Steps

- The AI has been patched and is undergoing another round of testing to confirm stability.
- Awaiting feedback from the latest testing session.

## Feedback

- (Pending next testing session)
