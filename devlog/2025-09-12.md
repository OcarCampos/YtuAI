# Devlog for 2025-09-12

## Session Summary

Addressing the key feedback points from the last extensive playtest.

1.  **Correcting Smart SP Management**: The "Balanced" SP strategy is currently being skipped. We will investigate and fix the logic to ensure all three tiers (Aggressive, Balanced, Conservative) are used correctly.
2.  **Tuning HP-Based Recovery**: The homunculus is re-engaging in combat before reaching the designated `RecoverHP` threshold. We will adjust the recovery logic to enforce the proper safety buffer.
3.  **Fixing Skill Cooldowns**: The `Caprice` skill is being spammed, ignoring its cooldown. We will diagnose and fix the cooldown implementation to ensure efficient skill casting.
4.  **Reviewing Legacy `Aggro` Settings**: The original `AggroHP` and `AggroSP` parameters may be conflicting with the new recovery systems. We will analyze their interaction and neutralize any interference.
5.  **Refactoring the Economic Suicide Tactic**: The current suicide logic is not behaving as intended. We will refactor this feature into a dedicated `SUICIDAL_ST` state with a more reliable attack-idle pattern.
6.  **Implementing Auto-Buff Feature**: As a new enhancement, we will add logic to auto-cast `Chaotic Blessings` when the homunculus and owner are idle.

## Changes Made

- **Refactored SP Management Logic**:
    - Identified a conflict where the legacy `AggroSP` variable was preventing the new Smart SP tiered logic from functioning correctly. The old check would make the AI passive before the "Balanced" or "Conservative" tiers could be used.
    - Removed all logic related to `AggroSP` from [AI_main.lua](../YtuAI/USER_AI/AI_main.lua) to ensure that the decision to find a target is no longer dependent on SP. This gives the `ChooseSkill` engine full control over resource management during combat.
    - Commented out the `AggroSP` definition in [H_Config.lua](../YtuAI/USER_AI/H_Config.lua) to complete its removal from the active codebase.
    - Corrected the `min_sp_pct` condition in [H_Skills.lua](../YtuAI/USER_AI/H_Skills.lua) by commenting it out, allowing the dynamic `priority` function to be the single source of truth for skill-casting decisions based on SP.

- **Neutralized Legacy `AttackSkillReserveSP`**:
    - Investigated the legacy `AttackSkillReserveSP` variable and confirmed it operates on a conflicting, flat-value SP reservation system.
    - To prevent conflicts with the new tiered SP logic, its usage in [AzzyUtil.lua](../YtuAI/USER_AI/AzzyUtil.lua) was modified to return `0`, effectively disabling the check.
    - The variable definition was then commented out in [H_Config.lua](../YtuAI/USER_AI/H_Config.lua) to complete its removal from the active logic.

- **Tuned HP-Based Recovery Logic**:
    - Fixed an issue where the homunculus would re-engage in combat immediately after reaching the `RecoverHP` threshold, without a safety buffer.
    - Added a `return` statement in the `OnIDLE_ST` recovery check in [AI_main.lua](../YtuAI/USER_AI/AI_main.lua). This forces the AI to wait for one full AI cycle after recovery is complete before it can search for new targets, ensuring it doesn't jump back into a fight prematurely.

- **Removed Legacy `AggroHP` Variable**:
    - Assessed the legacy `AggroHP` variable and confirmed it was made redundant by the modern `FleeHP`/`RecoverHP` system.
    - Removed all logic dependent on `AggroHP` from [AI_main.lua](../YtuAI/USER_AI/AI_main.lua) to simplify the aggression checks.
    - Commented out the `AggroHP` definition in [H_Config.lua](../YtuAI/USER_AI/H_Config.lua) to finalize its removal. This makes the new recovery system the single source of truth for HP-based safety.

- **Fixed Skill Cooldown System**:
    - Identified a disconnect between the cooldown logic and the skill selection process that was causing Caprice to be spammed.
    - Integrated cooldown checks directly into the `ChooseSkill()` function in [AzzyUtil.lua](../YtuAI/USER_AI/AzzyUtil.lua) to prevent skills on cooldown from being selected.
    - Moved the cooldown formula for Caprice to [H_Skills.lua](../YtuAI/USER_AI/H_Skills.lua) as a `cooldown` property, making it part of the skill definition.
    - Replaced the Caprice-specific cooldown setting in [AI_main.lua](../YtuAI/USER_AI/AI_main.lua) with a generic approach that works for any skill with a defined cooldown formula.
    - Removed the redundant cooldown check that happened after skill selection, ensuring a more efficient and maintainable codebase.
    - Fixed a critical issue where the old cooldown system in `DoSkill` was overwriting the cooldown set by the new system by adding a condition to only set cooldowns for skills not handled by the new system.
    - Added detailed logging for cooldown-related events to help diagnose any future issues.
    - Added a check to prevent skill casting attempts when the homunculus is out of sight of the owner, which was causing occasional "Can't cast skill" messages.

- **Improved Economic Suicide Tactic**:
    - Completely redesigned the suicide tactic to implement a more effective pattern of behavior.
    - Added a sub-state system within the `SUICIDE_ST` state to control the homunculus's actions:
        - `SUICIDE_ATTACK_SUBSTATE`: Find a target and perform a single attack
        - `SUICIDE_WAIT_SUBSTATE`: Wait for 10 seconds before attacking again
    - Implemented a more robust targeting system that uses the existing enemy selection logic.
    - Added fallback behavior to find any monster if no valid targets are found through normal targeting.
    - For Vanilmirth homunculi, implemented a specific weak attack using Caprice level 1 to avoid killing monsters.
    - Added detailed logging to track the suicide behavior for easier debugging.
    - Added proper initialization of suicide state variables when entering suicide mode.
    - **Note**: The current implementation includes Vanilmirth-specific code for using Caprice level 1. This will need to be expanded in the future to support other homunculus types and mercenaries with appropriate weak attacks.

## Bug Fixes & Testing

- **Fixed GetSkillName Error**:
    - Fixed an error in the cooldown setting code that was trying to use a non-existent `GetSkillName` function.
    - Updated the cooldown logging to use the skill ID directly instead of trying to get the skill name.
    - This fix ensures the cooldown system works properly without causing runtime errors.

## Adjustments & Tuning

...

## New Features

...

## Next Steps

- **Documentation:**
    - Update YtuAI_Documentation.md to reflect the changes made to the codebase and to remove legacy variables that are no longer being used.
    - Update Configuration.md to delete legacy variables that are no longer being used.

- **Implement Auto-Casting for Chaotic Blessings**: 
    - Add functionality to automatically cast Chaotic Blessings when the homunculus and owner are passive (standing or sitting).
    - This will improve quality of life for Vanilmirth users by providing buffs during downtime.
    - Consider appropriate conditions for when this should trigger (e.g., minimum SP threshold, cooldown period).

- **Review legacy kiting system**: 
    - Review the old kiting system 
    - Consider a merge with the new kiting system or deletion in favor of the new system.

- **Legacy variables:**
    - Assess UseDanceAttack variable.
    - Assess AutoSkillDelay.
    - Assess AutoSkillDelay.
    - Assess ForceKite.

- **Run time error:**
    - When encountered a Doram player who had a Pope hired as mercenary passing by near the homunculus run time error showed up. Error stated: 
    ```
    AI_main.lua:1941: attempt to call global 'GetNearestEnemy' (a nil value)
    ```
    Action being perfomed at moment of error was attacking another monsters in the area. Probably beacuse the pope was recognized as monster and not mercenary, when assessing the scene, as mercenary is a monster but in mercenary state, GetNearestEnemy failed.

## Feedback

### Play Test

- âœ… Fixed: Caprice skill spam issue resolved by implementing proper cooldown handling and preventing skill usage when out of sight of owner.
- Flee tactic not working properly. Homunculus flees from attacker, but not to owner position, it runs away a couple of cells and stays there. Monster reaches him and kills him. Flee tactic should be reevaluated to make homunculus flee to owners position for safety.



